<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Navigate - Accessible Chennai</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0b596c;
      --primary-dark: #106e8d;
      --accent: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --blue-gradient: linear-gradient(135deg, #0a4861 0%, #145974 100%);
      --glow-blue: 0 0 20px rgba(59, 130, 246, 0.5);
      --glow-accent: 0 0 15px rgba(245, 158, 11, 0.6);
    }

    * {
      scroll-behavior: smooth;
    }

    body {
      background: linear-gradient(135deg, #08354a 0%, #05374e 25%, #0e4e6c 50%, #0d5565 75%, #0e5f71 100%);
      background-size: 400% 400%;
      animation: gradientFlow 15s ease infinite;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .glow-primary {
      box-shadow: var(--glow-blue);
      transition: all 0.3s ease;
    }

    .glow-primary:hover {
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.8);
      transform: translateY(-2px);
    }

    .glow-accent {
      box-shadow: var(--glow-accent);
    }

    .voice-toggle {
      position: relative;
      width: 80px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .voice-toggle.active {
      background: var(--blue-gradient);
      box-shadow: var(--glow-blue);
      border-color: #3b82f6;
    }

    .voice-toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 30px;
      height: 30px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-toggle.active .voice-toggle-slider {
      transform: translateX(40px);
      background: #fff;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }

    .audio-wave {
      display: none;
      position: absolute;
      right: -30px;
      top: 50%;
      transform: translateY(-50%);
    }

    .voice-toggle.active .audio-wave {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .wave-bar {
      width: 3px;
      height: 15px;
      background: #3b82f6;
      border-radius: 2px;
      animation: waveAnimation 1.5s ease-in-out infinite;
    }

    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }

    @keyframes waveAnimation {
      0%, 100% { height: 10px; opacity: 0.3; }
      50% { height: 25px; opacity: 1; }
    }

    .route-card {
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.6s ease;
    }

    .route-card.show {
      transform: translateY(0);
      opacity: 1;
    }

    .route-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .parallax-section {
      transform: translateY(50px);
      opacity: 0;
      transition: all 0.8s ease;
    }

    .parallax-section.visible {
      transform: translateY(0);
      opacity: 1;
    }

    .transit-icon {
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .live-border {
      border: 2px solid transparent;
      background: linear-gradient(45deg, #3b82f6, #60a5fa) border-box;
      background-clip: padding-box, border-box;
      animation: borderGlow 3s ease-in-out infinite;
    }

    @keyframes borderGlow {
      0%, 100% { border-color: rgba(59, 130, 246, 0.5); }
      50% { border-color: rgba(59, 130, 246, 1); }
    }

    .route-card.selected {
      animation: routeSelect 0.8s ease;
    }

    @keyframes routeSelect {
      0% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.05) rotate(2deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    .hover-light {
      position: relative;
      overflow: hidden;
    }

    .hover-light::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .hover-light:hover::before {
      left: 100%;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    button:focus, input:focus, select:focus {
      outline: 3px solid #f59e0b;
      outline-offset: 2px;
    }

    .refresh-indicator {
      display: inline-block;
      animation: rotate 2s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .slide-in-left {
      transform: translateX(-50px);
      opacity: 0;
      transition: all 0.6s ease;
    }

    .slide-in-left.show {
      transform: translateX(0);
      opacity: 1;
    }

    .slide-in-right {
      transform: translateX(50px);
      opacity: 0;
      transition: all 0.6s ease;
    }

    .slide-in-right.show {
      transform: translateX(0);
      opacity: 1;
    }

    .map-redirect-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .map-redirect-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 1rem;
      text-align: center;
      max-width: 400px;
      animation: bounceIn 0.6s ease;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    .voice-guide-button {
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
    }

    select {
      appearance: none;
      background-color: #FFFFFF;
      color: #000000;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #3b82f6;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    select:focus {
      border-color: #f59e0b;
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
      transform: scale(1.02);
    }

    select option {
      padding: 10px;
      background-color: #FFFFFF;
      color: #000000;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
    }

    select option:hover {
      background-color: #e0f7ff;
      color: #000000;
      font-weight: 600;
    }

    select option:checked {
      background-color: #e0f7ff;
      transform: scale(1.05);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }

    select::-webkit-scrollbar {
      width: 8px;
    }

    select::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    select::-webkit-scrollbar-thumb {
      background: #3b82f6;
      border-radius: 4px;
    }

    .listening-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(59, 130, 246, 0.95);
      color: white;
      padding: 20px 40px;
      border-radius: 20px;
      font-size: 18px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @media (max-width: 768px) {
      select {
        font-size: 14px;
        padding: 10px;
        max-height: 150px;
      }

      .voice-toggle {
        width: 60px;
        height: 30px;
      }
      
      .voice-toggle-slider {
        width: 24px;
        height: 24px;
      }
      
      .voice-toggle.active .voice-toggle-slider {
        transform: translateX(30px);
      }
    }

    @media (prefers-contrast: high) {
      .glass, .glass-strong {
        background: rgba(255, 255, 255, 0.9);
        color: #000;
      }

      select {
        background-color: #FFFFFF;
        color: #000000;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body class="text-white">
  <header class="fixed top-0 w-full z-50 glass backdrop-blur-xl">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <a href="#" class="flex items-center space-x-1 focusable rounded-md" aria-label="Accessible Chennai Home">
            <div class="w-20 h-20 rounded-full flex items-center justify-center">
              <img src="ACCESSIBLECHENNAII.png" alt="Accessible Chennai Logo" class="w-16 h-16 object-cover rounded-full">
            </div>
            <h1 class="text-2xl font-bold">Accessible<span class="bg-gradient-to-r from-blue-300 to-cyan-300 bg-clip-text text-transparent"> Chennai</span></h1>
          </a>
        </div>
        <nav>
          <a href="voicemode.html" class="text-blue-200 hover:text-white mx-3" aria-label="Home">Home</a>
          <a href="navigate2.html" class="text-white font-semibold mx-3" aria-label="Navigate">Navigate</a>
          <a href="alerts2.html" class="text-blue-200 hover:text-white mx-3" aria-label="Alerts">Alerts</a>
        </nav>
      </div>
    </div>
  </header>

  <main class="pt-32 pb-12 max-w-7xl mx-auto px-4">
    <section class="mb-12 parallax-section">
      <div class="glass-strong p-8 rounded-3xl">
        <h2 class="text-4xl font-bold mb-6 text-center">
          <i class="fas fa-route text-blue-300 mr-3" aria-hidden="true"></i>
          Plan Your Journey
        </h2>
        
        <form id="journey-form" class="space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <div class="slide-in-left">
              <label for="current-location" class="block text-lg font-semibold mb-3">
                <i class="fas fa-map-marker-alt text-green-400 mr-2" aria-hidden="true"></i>
                Start Location
              </label>
              <div class="relative">
                <select 
                  id="current-location" 
                  class="w-full p-4 rounded-xl text-black"
                  aria-label="Select your current location"
                >
                  <option value="" disabled selected>Select your current location</option>
                  <option value="Adyar">Adyar</option>
                  <option value="Alwarpet">Alwarpet</option>
                  <option value="Anna Nagar">Anna Nagar</option>
                  <option value="Ashok Nagar">Ashok Nagar</option>
                  <option value="Besant Nagar">Besant Nagar</option>
                  <option value="Chetpet">Chetpet</option>
                  <option value="Chennai Central Railway Station">Chennai Central Railway Station</option>
                  <option value="Chennai International Airport">Chennai International Airport</option>
                  <option value="Chromepet">Chromepet</option>
                  <option value="Egmore">Egmore</option>
                  <option value="Express Avenue Mall">Express Avenue Mall</option>
                  <option value="Guindy">Guindy</option>
                  <option value="Kilpauk">Kilpauk</option>
                  <option value="Kodambakkam">Kodambakkam</option>
                  <option value="Koyambedu">Koyambedu</option>
                  <option value="Marina Beach">Marina Beach</option>
                  <option value="Mount Road">Mount Road</option>
                  <option value="Mylapore">Mylapore</option>
                  <option value="Nungambakkam">Nungambakkam</option>
                  <option value="Perambur">Perambur</option>
                  <option value="Phoenix MarketCity Mall">Phoenix MarketCity Mall</option>
                  <option value="Royapettah">Royapettah</option>
                  <option value="Saidapet">Saidapet</option>
                  <option value="T. Nagar">T. Nagar</option>
                  <option value="Tambaram">Tambaram</option>
                  <option value="Teynampet">Teynampet</option>
                  <option value="Thiruvanmiyur">Thiruvanmiyur</option>
                  <option value="Vadapalani">Vadapalani</option>
                  <option value="Velachery">Velachery</option>
                </select>
              </div>
            </div>
            
            <div class="slide-in-right">
              <label for="destination" class="block text-lg font-semibold mb-3">
                <i class="fas fa-flag-checkered text-red-400 mr-2" aria-hidden="true"></i>
                Destination
              </label>
              <div class="relative">
                <select 
                  id="destination" 
                  class="w-full p-4 rounded-xl text-black"
                  aria-label="Select your destination"
                >
                  <option value="" disabled selected>Select your destination</option>
                  <option value="Adyar">Adyar</option>
                  <option value="Alwarpet">Alwarpet</option>
                  <option value="Anna Nagar">Anna Nagar</option>
                  <option value="Ashok Nagar">Ashok Nagar</option>
                  <option value="Besant Nagar">Besant Nagar</option>
                  <option value="Chetpet">Chetpet</option>
                  <option value="Chennai Central Railway Station">Chennai Central Railway Station</option>
                  <option value="Chennai International Airport">Chennai International Airport</option>
                  <option value="Chromepet">Chromepet</option>
                  <option value="Egmore">Egmore</option>
                  <option value="Express Avenue Mall">Express Avenue Mall</option>
                  <option value="Guindy">Guindy</option>
                  <option value="Kilpauk">Kilpauk</option>
                  <option value="Kodambakkam">Kodambakkam</option>
                  <option value="Koyambedu">Koyambedu</option>
                  <option value="Marina Beach">Marina Beach</option>
                  <option value="Mount Road">Mount Road</option>
                  <option value="Mylapore">Mylapore</option>
                  <option value="Nungambakkam">Nungambakkam</option>
                  <option value="Perambur">Perambur</option>
                  <option value="Phoenix MarketCity Mall">Phoenix MarketCity Mall</option>
                  <option value="Royapettah">Royapettah</option>
                  <option value="Saidapet">Saidapet</option>
                  <option value="T. Nagar">T. Nagar</option>
                  <option value="Tambaram">Tambaram</option>
                  <option value="Teynampet">Teynampet</option>
                  <option value="Thiruvanmiyur">Thiruvanmiyur</option>
                  <option value="Vadapalani">Vadapalani</option>
                  <option value="Velachery">Velachery</option>
                </select>
              </div>
            </div>
          </div>

          <div class="parallax-section">
            <h3 class="text-2xl font-semibold mb-4">
              <i class="fas fa-universal-access text-purple-400 mr-2" aria-hidden="true"></i>
              Accessibility Requirements
            </h3>
            <div class="grid md:grid-cols-3 gap-4">
              <label class="glass p-4 rounded-xl cursor-pointer hover-light hover:bg-blue-500/20 transition-all">
                <input type="checkbox" id="wheelchair-access" class="mr-3">
                <i class="fas fa-wheelchair text-green-400 mr-2" aria-hidden="true"></i>
                Wheelchair Access
              </label>
              <label class="glass p-4 rounded-xl cursor-pointer hover-light hover:bg-blue-500/20 transition-all">
                <input type="checkbox" id="voice-guide" class="mr-3" checked>
                <i class="fas fa-volume-up text-blue-400 mr-2" aria-hidden="true"></i>
                Voice Guide
              </label>
              <label class="glass p-4 rounded-xl cursor-pointer hover-light hover:bg-blue-500/20 transition-all">
                <input type="checkbox" id="step-free" class="mr-3">
                <i class="fas fa-walking text-yellow-400 mr-2" aria-hidden="true"></i>
                Step-Free Path
              </label>
            </div>
          </div>

          <div class="text-center parallax-section">
            <button 
              type="submit" 
              class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-12 py-4 rounded-2xl text-xl font-bold hover-light glow-primary transition-all duration-300"
              aria-label="Find accessible route"
            >
              <i class="fas fa-search-location mr-3" aria-hidden="true"></i>
              <span id="route-button-text">Find Accessible Route</span>
            </button>
          </div>
        </form>
      </div>
    </section>

    <section id="route-results" class="mb-12 hidden">
      <div class="glass-strong p-8 rounded-3xl">
        <h3 class="text-3xl font-bold mb-6 text-center">
          <i class="fas fa-route text-blue-300 mr-3" aria-hidden="true"></i>
          Your Accessible Route Options
        </h3>
        <div id="route-cards" class="space-y-6">
        </div>
      </div>
    </section>
  </main>

  <div id="map-overlay" class="map-redirect-overlay">
    <div class="map-redirect-content">
      <i class="fas fa-map-marked-alt text-blue-500 text-6xl mb-4 animate-pulse" aria-hidden="true"></i>
      <h3 class="text-2xl font-bold text-gray-800 mb-4">Opening Google Maps</h3>
      <p class="text-gray-600 mb-6">Your accessible route will open in Google Maps with voice navigation ready. MTC Buses and Train routes will be highlighted.</p>
      <div class="flex justify-center space-x-4">
        <button onclick="proceedToMaps()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
          Continue
        </button>
        <button onclick="closeMapOverlay()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <div id="listening-indicator" class="listening-indicator">Listening...</div>

  <script>
    // Global variables
    let speechSynthesis = window.speechSynthesis;
    let speechRecognition = null;
    let currentRoute = null;
    let voiceInteractionState = {
      isActive: true, // Voice assistant enabled by default
      currentStep: 0, // 0: initial, 1: start location, 2: destination, 3: find route, 4: select option, 5: start navigation
      listening: false,
      currentLocation: null,
      destination: null
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      setupSpeechRecognition();
      startVoiceInteraction();
    });

    function initializeApp() {
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible', 'show');
          }
        });
      }, observerOptions);

      document.querySelectorAll('.parallax-section, .slide-in-left, .slide-in-right').forEach(el => {
        observer.observe(el);
      });

      document.getElementById('journey-form').addEventListener('submit', handleRouteSearch);

      // Ensure voice guide is enabled by default
      document.getElementById('voice-guide').checked = true;
    }

    function setupSpeechRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        speechRecognition = new SpeechRecognition();
        speechRecognition.continuous = false;
        speechRecognition.interimResults = false;
        speechRecognition.lang = 'en-IN';
        
        speechRecognition.onresult = (event) => {
          const result = event.results[0][0].transcript.toLowerCase().trim();
          voiceInteractionState.listening = false;
          document.getElementById('listening-indicator').style.display = 'none';
          processVoiceCommand(result);
        };

        speechRecognition.onerror = (event) => {
          voiceInteractionState.listening = false;
          document.getElementById('listening-indicator').style.display = 'none';
          if (event.error === 'not-allowed') {
            voiceInteractionState.isActive = false;
            speakMessage('Microphone access is denied. Please enable microphone permissions to use voice navigation.');
          } else {
            speakMessage('Sorry, I could not understand. Please try again.', () => {
              startListening();
            });
          }
        };

        speechRecognition.onend = () => {
          voiceInteractionState.listening = false;
          document.getElementById('listening-indicator').style.display = 'none';
          if (voiceInteractionState.isActive && voiceInteractionState.currentStep !== 0) {
            startListening();
          }
        };
      } else {
        voiceInteractionState.isActive = false;
        speakMessage('Voice navigation is not supported in this browser. Please use the form to select locations.');
      }
    }

    function startListening() {
      if (speechRecognition && voiceInteractionState.isActive && !voiceInteractionState.listening) {
        try {
          speechRecognition.start();
          voiceInteractionState.listening = true;
          document.getElementById('listening-indicator').style.display = 'block';
          speakMessage('I am listening. Please speak now.');
        } catch (e) {
          console.log('Speech recognition error:', e);
        }
      }
    }

    function stopListening() {
      if (speechRecognition && voiceInteractionState.listening) {
        speechRecognition.stop();
        voiceInteractionState.listening = false;
        document.getElementById('listening-indicator').style.display = 'none';
      }
    }

    function startVoiceInteraction() {
      // Immediate welcome message with guidance for blind users
      speakMessage("Welcome to the Accessible Chennai navigation page. I am your voice assistant to help you navigate. I will guide you step-by-step. Please wait two seconds, then say your current location.", () => {
        setTimeout(() => {
          voiceInteractionState.currentStep = 1;
          speakMessage("Please say your current location now.", () => {
            startListening();
          });
        }, 2000);
      });
    }

    function speakMessage(message, callback) {
      if (!voiceInteractionState.isActive) {
        if (callback) callback();
        return;
      }

      speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(message);
      utterance.rate = 0.95;
      utterance.pitch = 1;
      utterance.volume = 1;
      utterance.lang = 'en-GB';

      // Select high-quality voice
      const voices = speechSynthesis.getVoices();
      if (voices.length > 0) {
        const preferredVoice = voices.find(voice => 
          voice.lang === 'en-GB' && voice.localService && voice.name.includes('Enhanced')
        ) || voices.find(voice => 
          voice.lang === 'en-GB' && voice.localService
        ) || voices.find(voice => 
          voice.lang.startsWith('en-') && voice.localService
        ) || voices.find(voice => 
          voice.lang === 'en-GB'
        );
        
        if (preferredVoice) {
          utterance.voice = preferredVoice;
        }
      }

      utterance.onend = () => {
        if (callback) callback();
      };

      // Preload voices to avoid lag
      if (!speechSynthesis.getVoices().length) {
        speechSynthesis.getVoices();
      }

      speechSynthesis.speak(utterance);
    }

    function processVoiceCommand(input) {
      if (!voiceInteractionState.isActive) return;

      const chennaiLocations = [
        'adyar', 'alwarpet', 'anna nagar', 'ashok nagar', 'besant nagar', 'chetpet',
        'chennai central railway station', 'central', 'chennai international airport', 'airport', 'chromepet',
        'egmore', 'express avenue mall', 'express avenue', 'guindy', 'kilpauk', 'kodambakkam', 'koyambedu',
        'marina beach', 'marina', 'mount road', 'mylapore', 'nungambakkam', 'perambur',
        'phoenix marketcity mall', 'phoenix mall', 'royapettah', 'saidapet', 't nagar', 't. nagar', 'tambaram',
        'teynampet', 'thiruvanmiyur', 'vadapalani', 'velachery'
      ];

      switch (voiceInteractionState.currentStep) {
        case 1: // Start location
          const startLocation = findBestMatch(input, chennaiLocations);
          if (startLocation) {
            voiceInteractionState.currentLocation = startLocation;
            setStartLocation(startLocation);
            voiceInteractionState.currentStep = 2;
            speakMessage(`Current location set to ${startLocation}. Please say your destination now.`, () => {
              startListening();
            });
          } else {
            speakMessage("Sorry, I didn't recognize that location. Please say your current location again, such as Anna Nagar or Marina Beach.", () => {
              startListening();
            });
          }
          break;

        case 2: // Destination
          const destination = findBestMatch(input, chennaiLocations);
          if (destination) {
            voiceInteractionState.destination = destination;
            setDestination(destination);
            voiceInteractionState.currentStep = 3;
            speakMessage(`Destination set to ${destination}. Please say YES to find an accessible route.`, () => {
              startListening();
            });
          } else {
            speakMessage("Sorry, I didn't recognize that destination. Please say your destination again, such as T. Nagar or Chennai Airport.", () => {
              startListening();
            });
          }
          break;

        case 3: // Find route
          if (input.includes('yes')) {
            voiceInteractionState.currentStep = 4;
            handleRouteSearch({ preventDefault: () => {} });
          } else {
            speakMessage("Please say YES to find an accessible route.", () => {
              startListening();
            });
          }
          break;

        case 4: // Select option
          if (input.includes('option 1') || input.includes('option one') || input.includes('first option')) {
            voiceInteractionState.currentStep = 5;
            currentRoute = 0;
            speakMessage("You selected option 1. Say START NAVIGATION to begin.", () => {
              startListening();
            });
          } else if (input.includes('option 2') || input.includes('option two') || input.includes('second option')) {
            voiceInteractionState.currentStep = 5;
            currentRoute = 1;
            speakMessage("You selected option 2. Say START NAVIGATION to begin.", () => {
              startListening();
            });
          } else if (input.includes('option 3') || input.includes('option three') || input.includes('third option')) {
            voiceInteractionState.currentStep = 5;
            currentRoute = 2;
            speakMessage("You selected option 3. Say START NAVIGATION to begin.", () => {
              startListening();
            });
          } else {
            speakMessage("Please choose one option. Say OPTION 1, OPTION 2, or OPTION 3.", () => {
              startListening();
            });
          }
          break;

        case 5: // Start navigation
          if (input.includes('start navigation')) {
            speakMessage("Opening Google Maps with your selected route.", () => {
              proceedToMaps();
            });
          } else {
            speakMessage("Please say START NAVIGATION to begin.", () => {
              startListening();
            });
          }
          break;
      }
    }

    function findBestMatch(input, locations) {
      // Direct match
      for (let location of locations) {
        if (input.includes(location)) {
          return formatLocationName(location);
        }
      }

      // Fuzzy matching for common variations
      const variations = {
        'anna nagar': ['anna', 'annanagar'],
        't nagar': ['t.nagar', 'tnagar', 'tee nagar'],
        'marina beach': ['marina'],
        'chennai central railway station': ['central', 'central station'],
        'chennai international airport': ['airport'],
        'express avenue mall': ['express avenue', 'express'],
        'phoenix marketcity mall': ['phoenix', 'phoenix mall'],
        'besant nagar': ['besant'],
        'thiruvanmiyur': ['thiruvamiyur', 'thiruvanmiyoor']
      };

      for (let [location, alts] of Object.entries(variations)) {
        for (let alt of alts) {
          if (input.includes(alt)) {
            return formatLocationName(location);
          }
        }
      }

      return null;
    }

    function formatLocationName(location) {
      const locationMap = {
        'adyar': 'Adyar',
        'alwarpet': 'Alwarpet',
        'anna nagar': 'Anna Nagar',
        'ashok nagar': 'Ashok Nagar',
        'besant nagar': 'Besant Nagar',
        'chetpet': 'Chetpet',
        'chennai central railway station': 'Chennai Central Railway Station',
        'central': 'Chennai Central Railway Station',
        'chennai international airport': 'Chennai International Airport',
        'airport': 'Chennai International Airport',
        'chromepet': 'Chromepet',
        'egmore': 'Egmore',
        'express avenue mall': 'Express Avenue Mall',
        'express avenue': 'Express Avenue Mall',
        'guindy': 'Guindy',
        'kilpauk': 'Kilpauk',
        'kodambakkam': 'Kodambakkam',
        'koyambedu': 'Koyambedu',
        'marina beach': 'Marina Beach',
        'marina': 'Marina Beach',
        'mount road': 'Mount Road',
        'mylapore': 'Mylapore',
        'nungambakkam': 'Nungambakkam',
        'perambur': 'Perambur',
        'phoenix marketcity mall': 'Phoenix MarketCity Mall',
        'phoenix mall': 'Phoenix MarketCity Mall',
        'royapettah': 'Royapettah',
        'saidapet': 'Saidapet',
        't nagar': 'T. Nagar',
        't. nagar': 'T. Nagar',
        'tambaram': 'Tambaram',
        'teynampet': 'Teynampet',
        'thiruvanmiyur': 'Thiruvanmiyur',
        'vadapalani': 'Vadapalani',
        'velachery': 'Velachery'
      };

      return locationMap[location] || location;
    }

    function setStartLocation(location) {
      const startSelect = document.getElementById('current-location');
      startSelect.value = location;
    }

    function setDestination(location) {
      const destSelect = document.getElementById('destination');
      destSelect.value = location;
    }

    function handleRouteSearch(event) {
      event.preventDefault();
      
      const currentLocation = document.getElementById('current-location').value;
      const destination = document.getElementById('destination').value;
      
      if (!destination || !currentLocation) {
        speakMessage('Please ensure both start location and destination are selected. Say your current location again.');
        voiceInteractionState.currentStep = 1;
        startListening();
        return;
      }

      const routeButton = document.getElementById('route-button-text');
      routeButton.innerHTML = '<div class="loading-spinner mr-2"></div> Finding Routes...';
      
      speakMessage('Searching for accessible routes. Please wait.');

      setTimeout(() => {
        displayRouteOptions(currentLocation, destination);
        routeButton.textContent = 'Find Accessible Route';
      }, 2500);
    }

    function displayRouteOptions(start, end) {
      const routeResults = document.getElementById('route-results');
      const routeCards = document.getElementById('route-cards');
      
      const accessibilityOptions = {
        wheelchair: document.getElementById('wheelchair-access').checked,
        voiceGuide: document.getElementById('voice-guide').checked,
        stepFree: document.getElementById('step-free').checked
      };

      const routes = generateRoutes(start, end, accessibilityOptions);
      
      routeCards.innerHTML = routes.map((route, index) => `
        <div class="route-card glass-strong p-6 rounded-2xl hover-light" data-route-index="${index}">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h4 class="text-2xl font-bold text-blue-300 mb-2">
                <i class="fas fa-${route.icon} mr-2" aria-hidden="true"></i>
                ${route.name}
              </h4>
              <p class="text-blue-200">${route.description}</p>
            </div>
            <div class="text-right">
              <div class="text-3xl font-bold text-green-400">${route.duration}</div>
              <div class="text-sm text-blue-300">${route.distance} • ${route.cost}</div>
            </div>
          </div>
          
          <div class="mb-4">
            <div class="flex items-center mb-3">
              <div class="flex text-yellow-400">
                ${Array(route.accessibilityRating).fill('<i class="fas fa-star"></i>').join('')}
                ${Array(5 - route.accessibilityRating).fill('<i class="far fa-star"></i>').join('')}
              </div>
              <span class="ml-2 text-sm text-blue-200">Accessibility Rating</span>
            </div>
            <div class="flex flex-wrap gap-2">
              ${route.features.map(feature => `
                <span class="px-3 py-1 bg-blue-500/30 text-blue-200 rounded-full text-sm border border-blue-400/30">
                  <i class="fas fa-check mr-1" aria-hidden="true"></i>${feature}
                </span>
              `).join('')}
            </div>
          </div>

          <div class="mb-6">
            <h5 class="font-semibold mb-3 text-blue-300">Route Steps:</h5>
            <div class="space-y-2">
              ${route.steps.map((step, stepIndex) => `
                <div class="flex items-start p-2 glass rounded-lg">
                  <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm mr-3 mt-0.5 flex-shrink-0">
                    ${stepIndex + 1}
                  </span>
                  <span class="text-blue-100">${step}</span>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="flex flex-wrap gap-3">
            <button 
              onclick="startNavigation(${index})"
              class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-semibold hover-light glow-accent transition-all flex items-center"
              aria-label="Start navigation for ${route.name}"
            >
              <i class="fas fa-route mr-2" aria-hidden="true"></i>
              Start Navigation
            </button>
            <button 
              onclick="shareRoute(${index})"
              class="glass px-6 py-3 rounded-xl font-semibold hover-light transition-all flex items-center"
              aria-label="Share ${route.name}"
            >
              <i class="fas fa-share-alt mr-2" aria-hidden="true"></i>
              Share Route
            </button>
            <button 
              onclick="saveRoute(${index})"
              class="glass px-6 py-3 rounded-xl font-semibold hover-light transition-all flex items-center"
              aria-label="Save ${route.name}"
            >
              <i class="fas fa-bookmark mr-2" aria-hidden="true"></i>
              Save Route
            </button>
          </div>
        </div>
      `).join('');

      routeResults.classList.remove('hidden');
      routeResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      setTimeout(() => {
        document.querySelectorAll('.route-card').forEach((card, index) => {
          setTimeout(() => {
            card.classList.add('show');
          }, index * 200);
        });
        
        // Announce routes one by one
        let delay = 1000;
        routes.forEach((route, index) => {
          setTimeout(() => {
            const routeAnnouncement = `Option ${index + 1}: ${route.name}, takes ${route.duration}, with an accessibility rating of ${route.accessibilityRating} out of 5 stars.`;
            speakMessage(routeAnnouncement);
          }, delay);
          delay += 4000;
        });

        // Ask for route selection after all routes are announced
        setTimeout(() => {
          speakMessage("Please choose one option. Say OPTION 1, OPTION 2, or OPTION 3.", () => {
            startListening();
          });
        }, delay);
      }, 300);
    }

    function generateRoutes(start, end, options) {
      const baseRoutes = [
        {
          name: 'Chennai Metro + Walk',
          description: 'Fastest route using accessible metro system',
          icon: 'subway',
          duration: '28 min',
          distance: '12.8 km',
          cost: '₹25-35',
          accessibilityRating: options.wheelchair ? 5 : 4,
          features: ['Wheelchair Access', 'Audio Announcements', 'Tactile Paths', 'Elevator Access'],
          steps: [
            `Walk 3 minutes from ${start} to nearest Metro station`,
            'Board Blue Line Metro (wheelchair accessible coach available)',
            'Travel 8 stations with Tamil & English announcements',
            'Transfer at Central Metro Station using accessible walkway',
            'Continue on Green Line for 4 more stations',
            `Exit using elevator and walk 5 minutes to ${end} via tactile pathway`
          ],
          transitMode: 'rail'
        },
        {
          name: 'MTC Low-Floor Bus',
          description: 'Direct bus route with accessibility features',
          icon: 'bus',
          duration: '42 min',
          distance: '15.2 km',
          cost: '₹8-12',
          accessibilityRating: options.wheelchair ? 4 : 3,
          features: ['Low-Floor Entry', 'Priority Seating', 'Audio Stops', 'Wheelchair Space'],
          steps: [
            `Walk 2 minutes to bus stop near ${start}`,
            'Board MTC Route 21G (wheelchair accessible low-floor bus)',
            'Audio announcements will announce each stop in Tamil and English',
            'Enjoy priority seating and wheelchair accommodation',
            `Request stop announcement 2 stops before ${end}`,
            `Exit using rear ramp and walk 3 minutes to destination`
          ],
          transitMode: 'bus'
        },
        {
          name: 'Mixed Transport (Optimized)',
          description: 'Combination of metro and bus for best accessibility',
          icon: 'route',
          duration: '35 min',
          distance: '13.5 km',
          cost: '₹20-30',
          accessibilityRating: options.stepFree ? 5 : 4,
          features: ['Full Accessibility Chain', 'Covered Walkways', 'Audio Guidance', 'Step-Free'],
          steps: [
            `Share auto to Metro station (wheelchair accessible vehicle available)`,
            'Take Metro Blue Line with full accessibility features',
            'Walk through covered accessible bridge to bus terminal',
            'Board connecting MTC bus with low-floor entry',
            'Audio navigation continues throughout journey',
            `Arrive at ${end} via accessible drop-off point`
          ],
          transitMode: 'bus,rail'
        }
      ];

      let filteredRoutes = baseRoutes;
      
      if (options.wheelchair) {
        filteredRoutes = filteredRoutes.filter(route => 
          route.features.includes('Wheelchair Access') || 
          route.features.includes('Low-Floor Entry') ||
          route.features.includes('Full Accessibility Chain')
        );
      }

      if (options.stepFree) {
        filteredRoutes = filteredRoutes.filter(route => 
          route.features.includes('Step-Free') || 
          route.features.includes('Elevator Access')
        );
      }

      return filteredRoutes.sort((a, b) => b.accessibilityRating - a.accessibilityRating);
    }

    function startNavigation(routeIndex) {
      const routeCard = document.querySelector(`[data-route-index="${routeIndex}"]`);
      routeCard.classList.add('selected');
      
      currentRoute = routeIndex;
      
      voiceInteractionState.currentStep = 5;
      speakMessage(`You selected option ${routeIndex + 1}. Say START NAVIGATION to begin.`, () => {
        startListening();
      });

      setTimeout(() => {
        routeCard.classList.remove('selected');
      }, 800);
    }

    function proceedToMaps() {
      const start = document.getElementById('current-location').value;
      const end = document.getElementById('destination').value;
      const routeCard = document.querySelector(`[data-route-index="${currentRoute}"]`);
      const transitMode = routeCard ? generateRoutes(start, end, {
        wheelchair: document.getElementById('wheelchair-access').checked,
        voiceGuide: document.getElementById('voice-guide').checked,
        stepFree: document.getElementById('step-free').checked
      })[currentRoute].transitMode : 'bus,rail';
      
      const mapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(start)}/${encodeURIComponent(end)}/?travelmode=transit&transit_mode=${transitMode}&dirflg=r`;
      
      window.location.href = mapsUrl;
      
      closeMapOverlay();
    }

    function closeMapOverlay() {
      document.getElementById('map-overlay').style.display = 'none';
    }

    function shareRoute(routeIndex) {
      const shareText = `Check out this accessible route I found in Chennai using Accessible Chennai app!`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Accessible Route - Chennai',
          text: shareText,
          url: window.location.href
        }).catch(() => {
          fallbackShare(shareText);
        });
      } else {
        fallbackShare(shareText);
      }
    }

    function fallbackShare(text) {
      if (navigator.clipboard) {
        const shareUrl = `${window.location.href}?route=${currentRoute}`;
        navigator.clipboard.writeText(`${text} ${shareUrl}`);
        speakMessage('Route link copied to clipboard.');
      }
    }

    function saveRoute(routeIndex) {
      const routeName = document.querySelector(`[data-route-index="${routeIndex}"] h4`).textContent.trim();
      
      if (typeof(Storage) !== "undefined") {
        let savedRoutes = JSON.parse(sessionStorage.getItem('savedRoutes') || '[]');
        const routeData = {
          index: routeIndex,
          name: routeName,
          start: document.getElementById('current-location').value,
          end: document.getElementById('destination').value,
          timestamp: new Date().toISOString()
        };
        
        savedRoutes.push(routeData);
        sessionStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
        speakMessage(`Route ${routeName} saved successfully.`);
      }
    }

    // Preload voices on load
    window.addEventListener('load', () => {
      speechSynthesis.getVoices();
      voiceInteractionState.isActive = true;
      startVoiceInteraction();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (speechRecognition) {
        speechRecognition.stop();
      }
      speechSynthesis.cancel();
    });
  </script>
</body>
</html>